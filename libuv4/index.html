<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href="https://cdn.bootcss.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/pygments.css">
        <title>libuvçº¿ç¨‹æ± çš„å®ç°</title>
    </head>
    <body class='main page'>
        <div class="" style="text-align:center; position:relative;">
            <img src=/static/img/misakar2.jpg width = "180px" height="180px"></img>
            <a class="navbar-brand border border-info" href="http://www.misakar.me" style="margin-left:50px">Misaka.r.Me</a>
        </div>
        <hr>
        <div class="container">
            <h1>libuvçº¿ç¨‹æ± çš„å®ç°</h1>
<hr/>

<blockquote>
<p>å®Œæ•´æºç è§: https://github.com/libuv/libuv/blob/v1.x/src/threadpool.c</p>
</blockquote>
<p>è¿™ç¯‡åšå®¢åˆ†ælibuvçº¿ç¨‹æ± çš„å®ç°. çº¿ç¨‹æ± æ˜¯å®ç°å¹¶å‘çš„ä¸é”™æ–¹æ¡ˆ, ç›¸æ¯”äºone thread per clientçš„å¤šçº¿ç¨‹æ¨¡å¼, çº¿ç¨‹æ± ç»´æŠ¤ä¸€å®šæ•°é‡çš„çº¿ç¨‹, è´Ÿè½½è¯·æ±‚, å¹¶ä¸”å¯ä»¥å®ç°çº¿ç¨‹çš„é‡ç”¨, é«˜çº§çš„çº¿ç¨‹æ± è¿˜å¯ä»¥æ ¹æ®å¹¶å‘æ•°åŠ¨æ€æ”¹å˜æ± çš„å¤§å°. å½“ç„¶, é«˜å¹¶å‘ä¸‹, å¤šçº¿ç¨‹æ¨¡å‹ã€çº¿ç¨‹æ± æ¨¡å‹éƒ½ä¼šå› ä¸ºåˆ›å»ºå¤§é‡çš„OSçº¿ç¨‹å¯¼è‡´æœåŠ¡å™¨å´©æºƒ. äºæ˜¯å°±æœ‰äº†å•çº¿ç¨‹å¹¶å‘, æ¯”å¦‚nodejsçš„äº‹ä»¶é©±åŠ¨, æ¯”å¦‚asyncioçš„åç¨‹.</p>
<h2>libuvçš„çº¿ç¨‹æ± ?</h2>
<blockquote>
<p>libuvçš„çº¿ç¨‹æ± ? ä¸æ˜¯å•çº¿ç¨‹å¹¶å‘ä¹ˆ?</p>
</blockquote>
<p>libuvçš„æ ¸å¿ƒç»„ä»¶å°±æ˜¯å•çº¿ç¨‹ã€äº‹ä»¶é©±åŠ¨çš„eventloop. </p>
<p><img alt="" src="http://docs.libuv.org/en/v1.x/_images/loop_iteration.png" /></p>
<p>eventloopè¿è¡Œçš„å„ä¸ªé˜¶æ®µæ£€æµ‹ç›¸åº”çš„äº‹ä»¶, è§¦å‘callback. è¿™é‡Œçš„äº‹ä»¶ä¸€èˆ¬æ˜¯è€—æ—¶çš„I/O, æ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ã€æ•°æ®åº“è®¿é—®. ä»¥ç½‘ç»œè¯·æ±‚ä¸ºä¾‹, eventloopä¼šåœ¨Poll for I/Oé˜¶æ®µé˜»å¡, è°ƒç”¨ç›¸åº”æ“ä½œç³»ç»Ÿçš„ç›‘å¬æœºåˆ¶(Linux: epoll; Mac: kqueue; Windows: IOCP), ç›‘å¬socketçš„å¯è¯»å’Œå¯å†™äº‹ä»¶, å¦‚æœsocketå¯è¯», å°±å¯ä»¥è§¦å‘ç›¸åº”çš„å¯è¯»äº‹ä»¶å›è°ƒ, è¿™æ—¶å›è°ƒä¸Šè°ƒç”¨æ ˆæ‰§è¡Œè¯»å–response chunk. è¿™é‡Œæœ‰ä¸€ä¸ª<a href="https://github.com/neo1218/async_ex/blob/master/async_cb.py">ç”¨Python selectorsæ¨¡å—å®ç°çš„å¾®å‹eventloopå¤„ç†ç½‘ç»œI/O</a>, å¯ä»¥å‚è€ƒ. <br/></p>
<p>å•çº¿ç¨‹å¹¶å‘, è·¨å¹³å°! æƒ³æƒ³éƒ½è§‰å¾—å¾ˆé…·ğŸ˜. å¯æ˜¯<a href="http://blog.libtorrent.org/2012/10/asynchronous-disk-io/">ç°å®å¾€å¾€å¾ˆæ®‹å¿</a>, ç£ç›˜è¯»å†™è¿˜æ˜¯éœ€è¦å¤šçº¿ç¨‹å®ç°å¼‚æ­¥, æ‰€ä»¥æ–‡ä»¶æ“ä½œã€æ•°æ®åº“è®¿é—®ç­‰è¿™äº›éœ€è¦è¿›è¡Œç£ç›˜è¯»å†™çš„å¼‚æ­¥è¯·æ±‚å°±è¢«é€’äº¤ç»™äº†çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¤„ç†. è¿™ç¯‡åšå®¢å°±å°†åˆ†æè¿™ä¸ªçº¿ç¨‹æ± çš„å®ç°.
<img alt="" src="http://docs.libuv.org/en/v1.x/_images/architecture.png" /></p>
<h2>libuvçš„çº¿ç¨‹</h2>
<p>çº¿ç¨‹æ± æ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹çš„ç»“æ„. libuvçš„çº¿ç¨‹æ˜¯OSçº¿ç¨‹, åœ¨POSIXç³»ç»Ÿä¸Šç”¨çš„æ˜¯<a href="http://pubs.opengroup.org/onlinepubs/7908799/xsh/pthread.h.html">pthread</a>; åœ¨Windowsç³»ç»Ÿä¸Šç”¨çš„æ˜¯<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682516(v=vs.85).aspx">Windowsçº¿ç¨‹</a>.</p>
<div class="codehilite"><pre><span></span><span class="cm">/* include/uv-unix.h */</span>
<span class="k">typedef</span> <span class="n">pthread_once_t</span> <span class="n">uv_once_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">pthread_t</span> <span class="n">uv_thread_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">pthread_mutex_t</span> <span class="n">uv_mutex_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">pthread_cond_t</span> <span class="n">uv_cond_t</span><span class="p">;</span>

<span class="cm">/* include/uv-win.h */</span>
<span class="k">typedef</span> <span class="n">HANDLE</span> <span class="n">uv_thread_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">HANDLE</span> <span class="n">uv_sem_t</span><span class="p">;</span>
</pre></div>


<p>libuvæä¾›äº†ä¸€ä¸ªè·¨å¹³å°çš„æ¥å£, æ¥å£çš„é£æ ¼æ¨¡ä»¿çš„æ˜¯pthreadé£æ ¼.</p>
<h2>libuvçº¿ç¨‹æ± </h2>
<p>libuvçº¿ç¨‹æ± ç”±ä¸¤å¤§å—ç»„æˆ: <strong><code>task queue</code></strong>, <strong><code>thread pool</code></strong>:</p>
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">QUEUE</span> <span class="n">wq</span><span class="p">;</span> <span class="c1">// task queue </span>
<span class="k">static</span> <span class="n">uv_thread_t</span> <span class="n">default_threads</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// thread pool</span>
</pre></div>


<p>task queueç”¨äºå­˜æ”¾å¼‚æ­¥ä»»åŠ¡è¯·æ±‚, æ˜¯ä¸€ä¸ª<a href="http://www.misakar.me/libuv1/">åŒå‘å¾ªç¯é“¾è¡¨</a>. <br/>
thread poolåˆ™æ˜¯åœ¨å †ä¸Šåˆ†é…çš„æ•°ç»„, <code>é»˜è®¤çº¿ç¨‹æ± å¤§å°æ˜¯4ä¸ªçº¿ç¨‹</code>. <br/>
çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—é˜Ÿé¦–å–å‡ºä»»åŠ¡æ‰§è¡Œ, æ–°çš„ä»»åŠ¡åˆ™è¢«æ·»åŠ åˆ°é˜Ÿå°¾.</p>
<div class="codehilite"><pre><span></span><span class="cm">/* æäº¤ä¸€ä¸ªæ–°çš„ä»»åŠ¡åˆ°task queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">post</span><span class="p">(</span><span class="n">QUEUE</span><span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ......</span>
  <span class="n">QUEUE_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
  <span class="c1">// ......</span>
<span class="p">}</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="cm">/* ç©ºé—²çº¿ç¨‹ä»task queueä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">worker</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">......</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">QUEUE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
  <span class="p">......</span>
<span class="p">}</span>
</pre></div>


<p>task queueå¯¹äºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ¥è¯´æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æº:</p>
<ul>
<li>åŒä¸€æ—¶åˆ», åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—é˜Ÿé¦–å–å‡ºä»»åŠ¡</li>
<li>å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º, ç©ºé—²çº¿ç¨‹éœ€è¿›å…¥ç­‰å¾…çŠ¶æ€(ä¸å ç”¨CPU), ç­‰å¾…è¢«æ¡ä»¶å˜é‡å”¤é†’</li>
</ul>
<p>libuvæä¾›äº†ä¸€ä¸ª<code>å…¨å±€äº’æ–¥é”</code>æ¥åŒæ­¥çº¿ç¨‹æ± ä¸­çº¿ç¨‹:</p>
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">uv_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idle_threads</span><span class="p">;</span> <span class="c1">// çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹æ•°</span>

<span class="cm">/* æäº¤ä¸€ä¸ªæ–°çš„ä»»åŠ¡åˆ°task queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">post</span><span class="p">(</span><span class="n">QUEUE</span><span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>     <span class="c1">// åŠ é”</span>
  <span class="n">QUEUE_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span> <span class="c1">// æ–°çš„ä»»åŠ¡è¢«æ’å…¥é˜Ÿåˆ—å°¾éƒ¨</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">idle_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>      <span class="c1">// å¦‚æœå­˜åœ¨ç©ºé—²çº¿ç¨‹</span>
    <span class="n">uv_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>   <span class="c1">// å”¤é†’(æ¡ä»¶å˜é‡)</span>
  <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>   <span class="c1">// é‡Šæ”¾é”</span>
<span class="p">}</span>

<span class="cm">/* ç©ºé—²çº¿ç¨‹ä»task queueä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">worker</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">;</span>
  <span class="n">QUEUE</span><span class="o">*</span> <span class="n">q</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>  <span class="c1">// åŠ é”</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">QUEUE_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// å¦‚æœtask queueä¸ºç©º</span>
      <span class="n">idle_threads</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="c1">// å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€, ç­‰å¾…è¢«æ¡ä»¶å˜é‡å”¤é†’</span>
      <span class="n">uv_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span> 
      <span class="n">idle_threads</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">QUEUE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span> <span class="c1">// è‹¥ä¸ä¸ºç©º, ä»ä»»åŠ¡é˜Ÿåˆ—é˜Ÿé¦–å–å‡ºä»»åŠ¡</span>
    <span class="p">......</span>
    <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span> <span class="c1">// é‡Šæ”¾é”</span>
  <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<p><img alt="" src="http://7xj431.com1.z0.glb.clouddn.com/Screen%20Shot%202017-02-21%20at%2019.42.47.png" /></p>
<p>äº†è§£äº†åŸºæœ¬å·¥ä½œåŸç†, ç»§ç»­æ·±å…¥ç»†èŠ‚. <br/>
libuvæä¾›äº†<code>uv_queue_work</code>å‘ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’å…¥ä»»åŠ¡è¯·æ±‚</p>
<div class="codehilite"><pre><span></span><span class="cm">/* å‡½æ•°æŒ‡é’ˆ: çº¿ç¨‹æ± å¤„ç†çš„ä»»åŠ¡å›è°ƒ */</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">uv_work_cb</span><span class="p">)(</span><span class="n">uv_work_t</span><span class="o">*</span> <span class="n">req</span><span class="p">);</span>
<span class="cm">/* å‡½æ•°æŒ‡é’ˆ: çº¿ç¨‹æ± å¤„ç†uv_work_cbå®Œæ¯•, ä¼šé€šçŸ¥è¯¥reqæ‰€å±çš„eventloopè¿è¡Œæ­¤afterå›è°ƒ */</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">uv_after_work_cb</span><span class="p">)(</span><span class="n">uv_work_t</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">uv_queue_work</span><span class="p">(</span><span class="n">uv_loop_t</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                  <span class="n">uv_work_t</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span>
                  <span class="n">uv_work_cb</span> <span class="n">work_cb</span><span class="p">,</span>
                  <span class="n">uv_after_work_cb</span> <span class="n">after_work_cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">work_cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="c1">// work_cb æ˜¯å®é™…è¯·æ±‚éœ€è¦å¤„ç†çš„ä»»åŠ¡å›è°ƒ, ä¸èƒ½ä¸ºç©º</span>
    <span class="k">return</span> <span class="n">UV_EINVAL</span><span class="p">;</span> <span class="c1">// invalid argument</span>

  <span class="c1">// åˆå§‹åŒ–è¯·æ±‚ç±»å‹ä¸ºUV_WORK</span>
  <span class="n">uv__req_init</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">UV_WORK</span><span class="p">);</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">work_cb</span> <span class="o">=</span> <span class="n">work_cb</span><span class="p">;</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">after_work_cb</span> <span class="o">=</span> <span class="n">after_work_cb</span><span class="p">;</span>
  <span class="n">uv__work_submit</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work_req</span><span class="p">,</span> <span class="n">uv__queue_work</span><span class="p">,</span> <span class="n">uv__queue_done</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* uv__queue_workå’Œuv__queue_doneæ˜¯å¯¹work_cbå’Œafter_work_cbçš„wrapper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uv__queue_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// container_of ç”¨äºæ ¹æ®æŒ‡å‘ç»“æ„ä½“ä¸­æŸä¸ªfieldçš„æŒ‡é’ˆè·å–è¯¥ç»“æ„ä½“å¯¹è±¡çš„æŒ‡é’ˆ</span>
  <span class="c1">// åŸºæœ¬åŸç†è§å›¾: https://tinyurl.com/znd9rsy</span>
  <span class="n">uv_work_t</span><span class="o">*</span> <span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">uv_work_t</span><span class="p">,</span> <span class="n">work_req</span><span class="p">);</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">work_cb</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uv__queue_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uv_work_t</span><span class="o">*</span> <span class="n">req</span><span class="p">;</span>
  <span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">uv_work_t</span><span class="p">,</span> <span class="n">work_req</span><span class="p">);</span>
  <span class="c1">// è¯¥reqæ‰§è¡Œå®Œæˆ, ä»eventloopä¸Šunregister</span>
  <span class="n">uv__req_unregister</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">after_work_cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="n">req</span><span class="o">-&gt;</span><span class="n">after_work_cb</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>uv__work_submit</code>è°ƒç”¨postå°†ä»»åŠ¡è¯·æ±‚æ’å…¥ä»»åŠ¡é˜Ÿåˆ—, å®ç°å¦‚ä¸‹:</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">uv__work_submit</span><span class="p">(</span><span class="n">uv_loop_t</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                     <span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span>
                     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">work</span><span class="p">)(</span><span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">),</span>
                     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">uv_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">once</span><span class="p">,</span> <span class="n">init_once</span><span class="p">);</span>
  <span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">w</span><span class="o">-&gt;</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span><span class="p">;</span>
  <span class="n">w</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
  <span class="n">post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span> <span class="c1">// postå®ç°è§ä¸Š</span>
<span class="p">}</span>
</pre></div>


<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„<code>uv_once</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">uv_once_t</span> <span class="n">once</span> <span class="o">=</span> <span class="n">UV_ONCE_INIT</span><span class="p">;</span>
</pre></div>


<p><code>uv_once(&amp;once, init_once)</code>;ä¿è¯<code>init_once</code>åˆå§‹åŒ–ä¾‹ç¨‹åªè¢«è°ƒç”¨ä¸€æ¬¡, æˆ‘ä»¬çŸ¥é“æ¯ä¸ªæ–°ä»»åŠ¡æ’å…¥é˜Ÿåˆ—éƒ½ä¼šè°ƒç”¨<code>uv__work_submit</code>, ä½¿ç”¨uv_once, çº¿ç¨‹æ± åªä¼šåœ¨ç¬¬ä¸€æ¬¡æäº¤ä»»åŠ¡æ—¶è¢«åˆå§‹åŒ–. <br/>
æˆ‘ä»¬æ¥çœ‹çœ‹çº¿ç¨‹æ± çš„åˆå§‹åŒ–è¿‡ç¨‹:</p>
<div class="codehilite"><pre><span></span><span class="c1">// æ ‡è®°çº¿ç¨‹æ± æ˜¯å¦è¢«åˆå§‹åŒ–</span>
<span class="c1">// å£°æ˜volatileç”¨äºå…³é—­ç¼–è¯‘å™¨å¯¹initializedçš„ä¼˜åŒ–ç¼“å­˜</span>
<span class="c1">// å› ä¸ºinitializedçš„å€¼åœ¨éšåä¼šè¢«æ›´æ”¹</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>
<span class="cp">#define MAX_THREADPOOL_SIZE 128  </span><span class="c1">// çº¿ç¨‹æ± çš„æœ€å¤§å¤§å°</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_once</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">val</span><span class="p">;</span>

  <span class="c1">// #define ARRAY_SIZE(a) (sizeof(a) / sizeof((a)[0]))</span>
  <span class="n">nthreads</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_threads</span><span class="p">);</span> <span class="c1">// nthreadsä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°</span>
  <span class="c1">// å¯ä»¥é€šè¿‡è®¾ç½®UV_THREADPOOL_SIZEç¯å¢ƒå˜é‡æ”¹å˜çº¿ç¨‹æ± çš„å¤§å°</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;UV_THREADPOOL_SIZE&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">nthreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span> <span class="c1">// string to integer</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nthreads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nthreads</span> <span class="o">&gt;</span> <span class="n">MAX_THREADPOOL_SIZE</span><span class="p">)</span>  <span class="c1">// è‡³å¤šMAX_THREADPOOL_SIZEä¸ªçº¿ç¨‹</span>
    <span class="n">nthreads</span> <span class="o">=</span> <span class="n">MAX_THREADPOOL_SIZE</span><span class="p">;</span>

  <span class="n">threads</span> <span class="o">=</span> <span class="n">default_threads</span><span class="p">;</span>  <span class="c1">// é»˜è®¤å¤§å°çš„çº¿ç¨‹æ± (4ä¸ªçº¿ç¨‹)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nthreads</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_threads</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// UV_THREADPOOL_SIZEé…ç½®çš„å¤§å°å¤§äºé»˜è®¤4ä¸ªçº¿ç¨‹, åˆ†é…æ–°çš„å†…å­˜</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="n">uv__malloc</span><span class="p">(</span><span class="n">nthreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">threads</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å†…å­˜ä¸å¤Ÿ, æ”¹å›é»˜è®¤4ä¸ªå¤§å°çš„çº¿ç¨‹æ± </span>
      <span class="n">nthreads</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_threads</span><span class="p">);</span>
      <span class="n">threads</span> <span class="o">=</span> <span class="n">default_threads</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// åˆå§‹åŒ–æ¡ä»¶å˜é‡</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">uv_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">))</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="c1">// åˆå§‹åŒ–å…¨å±€äº’æ–¥é”</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">uv_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">))</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="c1">// åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—</span>
  <span class="n">QUEUE_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthreads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uv_thread_create</span><span class="p">(</span><span class="n">threads</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
      <span class="c1">// ä»ç¬¬ä¸€ä¸ªçº¿ç¨‹å¼€å§‹ä¾æ¬¡åˆ›å»ºçº¿ç¨‹, æ‰§è¡Œä½“ä¸ºworker</span>
      <span class="n">abort</span><span class="p">();</span>
  <span class="c1">// æ ‡å¿—å·²åˆå§‹åŒ–</span>
  <span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>è™½ç„¶å¯ä»¥é€šè¿‡è®¾ç½®<code>UV_THREADPOOL_SIZE</code>ç¯å¢ƒå˜é‡æ”¹å˜çº¿ç¨‹æ± çš„å¤§å°,ä½†æ˜¯ç”±äºåˆå§‹åŒ–ä¾‹ç¨‹åœ¨ä¸€ä¸ªçº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸåªæ‰§è¡Œä¸€æ¬¡, æ‰€ä»¥libuvçš„çº¿ç¨‹æ± ä¸èƒ½å®ç°åŠ¨æ€æ‰©å®¹. æˆ‘ç¿»åˆ°äº†ä¸€ä¸ª<a href="https://github.com/joyent/libuv/issues/649">12å¹´çš„issue</a>, è¯´æ˜¯æ‰“ç®—åœ¨v1.0ç‰ˆæœ¬å®ç°<code>auto-scaling feature</code>, ä¸è¿‡æˆ‘åœ¨1.xçš„æºç é‡Œè¿˜æ²¡æ‰¾åˆ°:-(</p>
<hr/>

<p>çº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œä½“æ˜¯worker, æ˜¯çº¿ç¨‹æ‰§è¡Œçš„æ ¸å¿ƒé€»è¾‘:</p>
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">worker</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">;</span>
  <span class="n">QUEUE</span><span class="o">*</span> <span class="n">q</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>  <span class="c1">// åŠ é”</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">QUEUE_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// å¦‚æœtask queueä¸ºç©º</span>
      <span class="n">idle_threads</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="c1">// å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€, ç­‰å¾…è¢«æ¡ä»¶å˜é‡å”¤é†’</span>
      <span class="n">uv_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span> 
      <span class="n">idle_threads</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">QUEUE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span> <span class="c1">// è‹¥ä¸ä¸ºç©º, ä»ä»»åŠ¡é˜Ÿåˆ—é˜Ÿé¦–å–å‡ºä»»åŠ¡</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">exit_message</span><span class="p">)</span>
      <span class="c1">// å¦‚æœè¯¥è¯·æ±‚æ˜¯é€€å‡ºè¯·æ±‚</span>
      <span class="n">uv_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span> <span class="c1">// å”¤é†’çº¿ç¨‹å¤„ç†</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// å¦åˆ™, å°†ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­ç§»é™¤</span>
      <span class="n">QUEUE_REMOVE</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
      <span class="c1">// é‡ç½®è¿™ä¸ªèŠ‚ç‚¹çš„åŒå‘æŒ‡é’ˆæŒ‡å‘è‡ªå·±(é¿å…ç©ºæŒ‡é’ˆ)</span>
      <span class="n">QUEUE_INIT</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span> <span class="c1">// é‡Šæ”¾é”</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">exit_message</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="c1">// QUEUE_DATAå’Œcontainer_ofä½œç”¨ç›¸åŒ</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">QUEUE_DATA</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uv__work</span><span class="p">,</span> <span class="n">wq</span><span class="p">);</span>
    <span class="c1">// æ‰§è¡Œ work_cb, å¤„ç†ä»»åŠ¡</span>
    <span class="n">w</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
    <span class="c1">// ç»™è¯¥workeræ‰€å±eventloopçš„çº¿ç¨‹åŠ é”</span>
    <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
    <span class="c1">// æ ‡è®° work_cb å·²ç»å¤„ç†å®Œæ¯•</span>
    <span class="n">w</span><span class="o">-&gt;</span><span class="n">work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="c1">// å°†workeræ’å…¥è¯¥workeræ‰€å±eventloopçš„workeré˜Ÿåˆ—</span>
    <span class="n">QUEUE_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
    <span class="c1">// çº¿ç¨‹é—´é€šä¿¡</span>
    <span class="c1">// å½“å‰çº¿ç¨‹æ± çº¿ç¨‹å”¤é†’è¢«å¤„ç†workeræ‰€å±çš„eventloopçº¿ç¨‹è°ƒç”¨after_work_cbå›è°ƒ</span>
    <span class="n">uv_async_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_async</span><span class="p">);</span>
    <span class="c1">// é‡Šæ”¾eventloopçš„çº¿ç¨‹é”</span>
    <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>å¯ä»¥çœ‹åˆ°, çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ<code>w-&gt;work</code>å›è°ƒå¤„ç†ä»»åŠ¡, å¹¶ä¸”é€šè¿‡<code>uv_async_send</code>è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡, å”¤é†’eventloopçº¿ç¨‹å¤„ç†<code>after_work_cb</code>å›è°ƒ. ç”±äºeventloopä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„, æ‰€ä»¥å¤šçº¿ç¨‹é—´çš„eventloopæ“ä½œéœ€è¦åŠ é”. <br>
çº¿ç¨‹æ± çš„ä¸»è¦å®ç°æ¦‚æ‹¬å¦‚ä¸‹:</p>
<ul>
<li>å¯ä»¥é…ç½®<code>UV_THREADPOOL_SIZE</code>ç¯å¢ƒå˜é‡åœ¨åˆå§‹åŒ–æ—¶æ”¹å˜çº¿ç¨‹æ± å¤§å°</li>
<li>é€šè¿‡<code>uv_queue_work</code>é€’äº¤ä»»åŠ¡</li>
<li>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ä»»åŠ¡ä¼šåˆå§‹åŒ–çº¿ç¨‹æ± (<code>uv_once</code>)</li>
<li>çº¿ç¨‹æ± å¯åŠ¨å„ä¸ªçº¿ç¨‹æ‰§è¡Œworker</li>
<li>workerä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œ<code>work_cb</code>å›è°ƒ</li>
<li>æ‰§è¡Œå®Œä»»åŠ¡åçº¿ç¨‹å”¤é†’eventloopçº¿ç¨‹æ‰§è¡Œ<code>after_work_cb</code>å›è°ƒ</li>
</ul>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é€šè¿‡äº’æ–¥é”ã€æ¡ä»¶å˜é‡åšçº¿ç¨‹é—´åŒæ­¥.</p>
<hr/>

<p>libuvè¿˜æä¾›äº†ä¸€ä¸ªå–æ¶ˆä»»åŠ¡å‡½æ•°<code>uv_cancel</code>ç”¨äºå–æ¶ˆæŸä¸ªä»»åŠ¡è¯·æ±‚</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">uv_cancel</span><span class="p">(</span><span class="n">uv_req_t</span><span class="o">*</span> <span class="n">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">wreq</span><span class="p">;</span>
  <span class="n">uv_loop_t</span><span class="o">*</span> <span class="n">loop</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nl">UV_FS</span><span class="p">:</span>
    <span class="c1">// uv_req_t&quot;ç»§æ‰¿&quot;äº†uv_fs_t, å…³äºCç»“æ„ä½“çš„ç»§æ‰¿å¯ä»¥çœ‹http://www.misakar.me/libuv3/</span>
    <span class="n">loop</span> <span class="o">=</span>  <span class="p">((</span><span class="n">uv_fs_t</span><span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
    <span class="n">wreq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">uv_fs_t</span><span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">work_req</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">UV_GETADDRINFO</span><span class="p">:</span>
    <span class="p">......</span>
  <span class="k">case</span> <span class="nl">UV_GETNAMEINFO</span><span class="p">:</span>
    <span class="p">......</span>
  <span class="k">case</span> <span class="nl">UV_WORK</span><span class="p">:</span>
    <span class="p">......</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">UV_EINVAL</span><span class="p">;</span>  <span class="c1">// invalid argument</span>
  <span class="k">return</span> <span class="n">uv__work_cancel</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">wreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">uv__work_cancel</span><span class="p">(</span><span class="n">uv_loop_t</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="n">uv_req_t</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cancelled</span><span class="p">;</span>
  <span class="c1">// åŠ é”</span>
  <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
  <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
  <span class="c1">// å¦‚æœä»»åŠ¡æ²¡æœ‰ç»“æŸ(NULLæ ‡è®°ä»»åŠ¡ç»“æŸ)</span>
  <span class="n">cancelled</span> <span class="o">=</span> <span class="o">!</span><span class="n">QUEUE_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">work</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cancelled</span><span class="p">)</span>
    <span class="c1">// ç»“æŸä»»åŠ¡</span>
    <span class="n">QUEUE_REMOVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
  <span class="c1">// é‡Šæ”¾é”</span>
  <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
  <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cancelled</span><span class="p">)</span>
    <span class="c1">// å¦‚æœä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²ç»æ‰§è¡Œå®Œæ¯•</span>
    <span class="k">return</span> <span class="n">UV_EBUSY</span><span class="p">;</span> <span class="c1">// resource busy or locked</span>
  <span class="c1">// æ ‡è®°ä»»åŠ¡è¢«å–æ¶ˆ</span>
  <span class="n">w</span><span class="o">-&gt;</span><span class="n">work</span> <span class="o">=</span> <span class="n">uv__cancelled</span><span class="p">;</span>
  <span class="c1">// åŠ é”</span>
  <span class="n">uv_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
  <span class="n">QUEUE_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
  <span class="c1">// å”¤é†’eventloopå¤„ç†</span>
  <span class="n">uv_async_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_async</span><span class="p">);</span>
  <span class="c1">// é‡Šæ”¾é”</span>
  <span class="n">uv_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="o">-&gt;</span><span class="n">wq_mutex</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">uv__cancelled</span><span class="p">(</span><span class="k">struct</span> <span class="n">uv__work</span><span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abort</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>å¯ä»¥çœ‹åˆ°ä¹‹å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡å®Œæ¯•è®¾ç½®çš„<code>w-&gt;work=NULL</code>, åœ¨è¿™é‡Œå°±å¯ä»¥åˆ¤æ–­æŸä¸ªä»»åŠ¡æ˜¯å¦å·²è¢«æ‰§è¡Œ, è‹¥ä»»åŠ¡å·²è¢«æ‰§è¡Œ, é‚£ä¹ˆå°±ä¸èƒ½æ‰§è¡Œå–æ¶ˆæ“ä½œäº†. å–æ¶ˆä»»åŠ¡çš„æ“ä½œ<code>uv__cancelled</code>è¢«é€’äº¤åˆ°eventloopçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ.</p>
<h2>nodejså¯¹libuvçº¿ç¨‹æ± çš„ä½¿ç”¨</h2>
<p>jsæ˜¯å•çº¿ç¨‹çš„, æ˜¯é˜»å¡çš„, nodejså®ç°å¼‚æ­¥çš„æ ¸å¿ƒå°±æ˜¯libuv. å¯¹äºæ–‡ä»¶æ“ä½œ, ä»¥åŠä¸€äº›é˜»å¡çš„ç¬¬ä¸‰æ–¹æ“ä½œ, nodejséƒ½æ˜¯é€’äº¤ç»™libuvçº¿ç¨‹æ± å¤„ç†çš„. æ‰§è¡Œè¿‡ç¨‹å¦‚å›¾ </p>
<p><img alt="" src="https://www.future-processing.com/blog/wp-content/uploads/2015/04/threads-in-node.ja_.png" />
ä¾‹å¦‚(æˆªå›¾æ¥æºuvbook):
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/23166568/1269d8bc-f87c-11e6-8512-7a6c88c43b54.png" /></p>
<h2>nodejsæ˜¯å•çº¿ç¨‹çš„-&gt;è¿™æ˜¯è°è¨€å—?</h2>
<p><img alt="" src="https://cloud.githubusercontent.com/assets/10671733/23166613/46cb34ca-f87c-11e6-8c28-6886aa43bdd3.png" />
nodejsç¡®å®ä¸æ˜¯å•çº¿ç¨‹çš„, js v8 runtime, libuv eventloop, libuv threadpool. è€Œä¸”<a href="https://www.future-processing.pl/blog/on-problems-with-threads-in-node-js/">nodejsçš„threadpoolä½¿ç”¨ä¸å½“è¿˜ä¼šå¸¦æ¥é—®é¢˜</a>. 
æˆ‘è§‰å¾—å¤§å®¶è¯´nodejsæ˜¯å•çº¿ç¨‹çš„æ˜¯å› ä¸ºnodejsçš„æ ¸å¿ƒæ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„å•çº¿ç¨‹å¹¶å‘æ€æƒ³.æ‰€ä»¥è¯´nodejsæ˜¯å•çº¿ç¨‹è¿™ä¸èƒ½ç®—è°è¨€, æœ€å¤šæ˜¯å–„æ„çš„è°è¨€, å®ƒåªæ˜¯ä¸ºäº†æé†’æˆ‘ä»¬nodejså•çº¿ç¨‹å¹¶å‘çš„æ¨¡å‹.</p>
<hr>

<p>æœ€åä»¥Ryan Dahlçš„ä¸€å¥è¯ç»“æŸè¿™ç¯‡æºç åˆ†æå§: <strong><code>IO need to be done differently !</code></strong></p>
        </div>
<div id="bootpre">
    <script>
        var x = document.getElementsByClassName("codehilite");
        for (var i = 0; i < x.length; i++)
        {
            x[i].childNodes[0].className = "border border-danger";
        }
    </script>
</div>
<div id="h1center">
    <script>
        var x = document.getElementsByTagName("h1")[0].style="text-align:center";
    </script>
</div>
<div id="_blank">
    <script>
        var as = document.getElementsByTagName('a');
        // alert(as[1]);
        for (var i = 1; i < as.length; i++) {
            // as[i].style="target: _blank";
            as[i].setAttribute('target', '_blank');
        }
    </script>
</div>
<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://neo1218flask.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </body>
</html>