<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href="https://cdn.bootcss.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/pygments.css">
        <title>Pythonå°¾é€’å½’ä¼˜åŒ–</title>
    </head>
    <body class='main page'>
        <div class="" style="text-align:center; position:relative;">
            <img src=/static/img/misakar2.jpg width = "180px" height="180px"></img>
            <a class="navbar-brand border border-info" href="http://www.misakar.me" style="margin-left:50px">Misaka.r.Me</a>
        </div>
        <hr>
        <div class="container">
            <h1>Pythonå°¾é€’å½’ä¼˜åŒ–</h1>
<hr/>

<h2>ä¸€èˆ¬é€’å½’ä¸å°¾é€’å½’</h2>
<h3>ä¸€èˆ¬é€’å½’:</h3>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">normal_recursion</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">+</span> <span class="n">normal_recursion</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>æ‰§è¡Œï¼š</p>
<div class="codehilite"><pre><span></span>normal_recursion(5)
5 + normal_recursion(4)
5 + 4 + normal_recursion(3)
5 + 4 + 3 + normal_recursion(2)
5 + 4 + 3 + 2 + normal_recursion(1)
5 + 4 + 3 + 3
5 + 4 + 6
5 + 10
15
</pre></div>


<p>å¯ä»¥çœ‹åˆ°, ä¸€èˆ¬é€’å½’, æ¯ä¸€çº§é€’å½’éƒ½äº§ç”Ÿäº†æ–°çš„å±€éƒ¨å˜é‡, å¿…é¡»åˆ›å»ºæ–°çš„è°ƒç”¨æ ˆ, éšç€é€’å½’æ·±åº¦çš„å¢åŠ , åˆ›å»ºçš„æ ˆè¶Šæ¥è¶Šå¤š, é€ æˆçˆ†æ ˆğŸ’¥</p>
<h3>å°¾é€’å½’</h3>
<p>å°¾é€’å½’åŸºäºå‡½æ•°çš„å°¾è°ƒç”¨, æ¯ä¸€çº§è°ƒç”¨ç›´æ¥è¿”å›é€’å½’å‡½æ•°æ›´æ–°è°ƒç”¨æ ˆ, æ²¡æœ‰æ–°å±€éƒ¨å˜é‡çš„äº§ç”Ÿ, ç±»ä¼¼è¿­ä»£çš„å®ç°:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">tail_recursion</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">total</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tail_recursion</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="o">+</span><span class="n">n</span><span class="p">)</span>
</pre></div>


<p>æ‰§è¡Œï¼š</p>
<div class="codehilite"><pre><span></span>tail_recursion(5, 0)
tail_recursion(4, 5)
tail_recursion(3, 9)
tail_recursion(2, 12)
tail_recursion(1, 14)
tail_recursion(0, 15)
15
</pre></div>


<p>å¯ä»¥çœ‹åˆ°, å°¾é€’å½’æ¯ä¸€çº§é€’å½’å‡½æ•°çš„è°ƒç”¨å˜æˆ"çº¿æ€§"çš„å½¢å¼. è¿™æ—¶, æˆ‘ä»¬å¯ä»¥æ€è€ƒ, <code>è™½ç„¶å°¾é€’å½’è°ƒç”¨ä¹Ÿä¼šåˆ›å»ºæ–°çš„æ ˆ, ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–ä½¿å¾—å°¾é€’å½’çš„æ¯ä¸€çº§è°ƒç”¨å…±ç”¨ä¸€ä¸ªæ ˆ!</code>, å¦‚æ­¤ä¾¿å¯è§£å†³çˆ†æ ˆå’Œé€’å½’æ·±åº¦é™åˆ¶çš„é—®é¢˜! <br/></p>
<h2>Cä¸­å°¾é€’å½’çš„ä¼˜åŒ–</h2>
<p>gccä½¿ç”¨<code>-O2</code>å‚æ•°å¼€å¯å°¾é€’å½’ä¼˜åŒ–:</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">tail_recursion</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">total</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">total</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">tail_recursion</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="o">+</span><span class="n">n</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">tail_recursion</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">total</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>åæ±‡ç¼– </p>
<div class="codehilite"><pre><span></span>$ gcc -S tail_recursion.c -o normal_recursion.S
$ gcc -S -O2 tail_recursion.c -o tail_recursion.S gccå¼€å¯å°¾é€’å½’ä¼˜åŒ–
</pre></div>


<p>å¯¹æ¯”åæ±‡ç¼–ä»£ç å¦‚ä¸‹(AT&amp;Tè¯­æ³•, å·¦å›¾ä¸ºä¼˜åŒ–å) </p>
<p><img alt="ä¼˜åŒ–" src="https://cloud.githubusercontent.com/assets/10671733/20724681/24cfaffe-b6aa-11e6-85f8-fee65848f533.png" /></p>
<p>å¯ä»¥çœ‹åˆ°, å¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰, ä½¿ç”¨callè°ƒç”¨å‡½æ•°, åˆ›å»ºäº†æ–°çš„è°ƒç”¨æ ˆ(LBB0_3); è€Œå¼€å¯å°¾é€’å½’ä¼˜åŒ–å, å°±æ²¡æœ‰æ–°çš„è°ƒç”¨æ ˆç”Ÿæˆäº†, è€Œæ˜¯ç›´æ¥pop bpæŒ‡å‘çš„_tail_recursionå‡½æ•°çš„åœ°å€(pushq %rbp)ç„¶åè¿”å›,  ä»æ—§ç”¨çš„æ˜¯åŒä¸€ä¸ªè°ƒç”¨æ ˆ!</p>
<h2>Pythonå¼€å¯å°¾é€’å½’ä¼˜åŒ–</h2>
<p>cpythonæœ¬èº«ä¸æ”¯æŒå°¾é€’å½’ä¼˜åŒ–, ä½†æ˜¯ä¸€ä¸ªç‰›äººæƒ³å‡ºçš„è§£å†³åŠæ³•ï¼š<code>å®ç°ä¸€ä¸ª tail_call_optimized è£…é¥°å™¨</code></p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python2.4</span>
<span class="c1"># This program shows off a python decorator(</span>
<span class="c1"># which implements tail call optimization. It</span>
<span class="c1"># does this by throwing an exception if it is</span>
<span class="c1"># it&#39;s own grandparent, and catching such</span>
<span class="c1"># exceptions to recall the stack.</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">TailRecurseException</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<span class="k">def</span> <span class="nf">tail_call_optimized</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function decorates a function with tail call</span>
<span class="sd">    optimization. It does this by throwing an exception</span>
<span class="sd">    if it is it&#39;s own grandparent, and catching such</span>
<span class="sd">    exceptions to fake the tail call optimization.</span>

<span class="sd">    This function fails if the decorated</span>
<span class="sd">    function recurses in a non-tail context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_back</span> \
            <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_code</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="p">:</span>
            <span class="c1"># æŠ›å‡ºå¼‚å¸¸</span>
            <span class="k">raise</span> <span class="n">TailRecurseException</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">g</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">TailRecurseException</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">kwargs</span>
    <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="nd">@tail_call_optimized</span>
<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;calculate a factorial&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">acc</span>
    <span class="k">return</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span>

<span class="k">print</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> 
</pre></div>


<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹<code>sys._getframe()</code>å‡½æ•°:</p>
<blockquote>
<p>sys._getframe([depth]):
Return a frame object from the call stack.
If optional integer depth is given, return the frame object that many calls below the top of the stack.
If that is deeper than the call stack, ValueEfror is raised. The default for depth is zero,
returning the frame at the top of the call stack.</p>
</blockquote>
<p>å³è¿”å›depthæ·±åº¦è°ƒç”¨çš„æ ˆå¸§å¯¹è±¡. <br/></p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">get_cur_info</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>  <span class="c1"># å½“å‰æ–‡ä»¶å</span>
    <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>  <span class="c1"># å½“å‰å‡½æ•°å</span>
    <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_lineno</span> <span class="c1"># å½“å‰è¡Œå·</span>
    <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span> <span class="c1"># è°ƒç”¨è€…çš„å¸§</span>
</pre></div>


<p>æ›´å¤šå…³äº<code>sys._getframeçš„ä½¿ç”¨</code>è¯·çœ‹<a href="http://feihonghsu.com/secrets/framehack/index.html#crazy-monkey-patching-lxml">Frame Hacks</a> <br/>
è¯´ä¸€ä¸‹<code>tail_call_optimizedå®ç°å°¾é€’å½’ä¼˜åŒ–çš„åŸç†</code>: å½“é€’å½’å‡½æ•°è¢«è¯¥è£…é¥°å™¨ä¿®é¥°å, é€’å½’è°ƒç”¨åœ¨è£…é¥°å™¨whileå¾ªç¯å†…éƒ¨è¿›è¡Œ, æ¯å½“äº§ç”Ÿæ–°çš„é€’å½’è°ƒç”¨æ ˆå¸§æ—¶: <code>f.f_back.f_back.f_code == f.f_code:</code>, å°±æ•è·å½“å‰å°¾è°ƒç”¨å‡½æ•°çš„å‚æ•°, å¹¶æŠ›å‡ºå¼‚å¸¸, ä»è€Œé”€æ¯é€’å½’æ ˆå¹¶ä½¿ç”¨æ•è·çš„å‚æ•°æ‰‹åŠ¨è°ƒç”¨é€’å½’å‡½æ•°. æ‰€ä»¥é€’å½’çš„è¿‡ç¨‹ä¸­å§‹ç»ˆåªå­˜åœ¨ä¸€ä¸ªæ ˆå¸§å¯¹è±¡, è¾¾åˆ°ä¼˜åŒ–çš„ç›®çš„.<br/>
ä¸ºäº†æ›´æ¸…æ™°çš„å±•ç¤ºå¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰ã€åè°ƒç”¨æ ˆçš„å˜åŒ–å’Œtail_call_optimizedè£…é¥°å™¨æŠ›å¼‚å¸¸é€€å‡ºé€’å½’è°ƒç”¨æ ˆçš„ä½œç”¨, æˆ‘è¿™é‡Œåˆ©ç”¨pudbè°ƒè¯•å·¥å…·åšäº†åŠ¨å›¾: <br/></p>
<p>å¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰çš„è°ƒç”¨æ ˆ 
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20725973/b4e5d060-b6ae-11e6-9116-265cdd871b36.gif" /></p>
<p>å¼€å¯å°¾é€’å½’ä¼˜åŒ–å(tail_call_optimizedè£…é¥°å™¨)çš„è°ƒç”¨æ ˆ 
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20726110/1cfc8568-b6af-11e6-9817-1257b4c482f1.gif" /></p>
<p>é€šè¿‡pudbå³è¾¹æ çš„stack, å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°è°ƒç”¨æ ˆçš„å˜åŒ–. <br/>
å› ä¸ºå®ç°äº†å°¾é€’å½’ä¼˜åŒ–, æ‰€ä»¥factorial(10000)éƒ½ä¸å®³æ€•é€’å½’æ·±åº¦é™åˆ¶æŠ¥é”™å•¦! <br/></p>
        </div>
<div id="bootpre">
    <script>
        var x = document.getElementsByClassName("codehilite");
        for (var i = 0; i < x.length; i++)
        {
            x[i].childNodes[0].className = "border border-danger";
        }
    </script>
</div>
<div id="h1center">
    <script>
        var x = document.getElementsByTagName("h1")[0].style="text-align:center";
    </script>
</div>
<div id="_blank">
    <script>
        var as = document.getElementsByTagName('a');
        // alert(as[1]);
        for (var i = 1; i < as.length; i++) {
            // as[i].style="target: _blank";
            as[i].setAttribute('target', '_blank');
        }
    </script>
</div>
<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://neo1218flask.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </body>
</html>